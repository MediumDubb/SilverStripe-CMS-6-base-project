!function(){"use strict";var e={145:function(e){e.exports=ReactDomClient},207:function(e){e.exports=Injector},502:function(e){e.exports=ShortcodeSerialiser},594:function(e){e.exports=React},669:function(e){e.exports=jQuery},815:function(e){e.exports=i18n},984:function(e){e.exports=InsertEmbedModal}},t={};function n(o){var i=t[o];if(void 0!==i)return i.exports;var a=t[o]={exports:{}};return e[o](a,a.exports,n),a.exports}var o=c(n(669)),i=c(n(594)),a=n(145),r=n(207),d=function(e,t){if("function"==typeof WeakMap)var n=new WeakMap,o=new WeakMap;return function(e,t){if(!t&&e&&e.__esModule)return e;var i,a,r={__proto__:null,default:e};if(null===e||"object"!=typeof e&&"function"!=typeof e)return r;if(i=t?o:n){if(i.has(e))return i.get(e);i.set(e,r)}for(const t in e)"default"!==t&&{}.hasOwnProperty.call(e,t)&&((a=(i=Object.defineProperty)&&Object.getOwnPropertyDescriptor(e,t))&&(a.get||a.set)?i(r,t,a):r[t]=e[t]);return r}(e,t)}(n(502)),s=c(n(984)),l=c(n(815));function c(e){return e&&e.__esModule?e:{default:e}}const u=(0,r.loadComponent)(s.default),p='div[data-shortcode="embed"]';(()=>{const e=e=>{const t=l.default._t("TinyMCE.INSERT_VIA_URL","Insert media via URL"),n=l.default._t("TinyMCE.EDIT_MEDIA","Edit media"),i=l.default._t("TinyMCE.DELETE_MEDIA","Delete media"),a=l.default._t("TinyMCE.MEDIA","Media");return e.addCommand("ssembed",()=>{(0,o.default)(`#${e.id}`).entwine("ss").openEmbedDialog()}),e.addCommand("ssembed-delete",()=>{const t=e.selection.getNode();e.dom.is(t,p)?t.remove():e.dom.is(t.parentNode,p)?t.parentNode.remove():console.error({error:"Unexpected selection - expected embed",selectedNode:t})}),e.ui.registry.addButton("ssembed",{tooltip:t,icon:"embed",onAction:()=>e.execCommand("ssembed"),stateSelector:p}),e.ui.registry.addMenuItem("ssembed",{text:a,icon:"embed",onAction:()=>e.execCommand("ssembed")}),e.ui.registry.addButton("ssembededit",{tooltip:n,icon:"edit-block",onAction:()=>e.execCommand("ssembed")}),e.ui.registry.addButton("ssembeddelete",{tooltip:i,icon:"remove",onAction:()=>e.execCommand("ssembed-delete")}),e.ui.registry.addContextToolbar("ssembed",{predicate:t=>e.dom.is(t,p),position:"node",scope:"node",items:"alignleft aligncenter alignright | ssembededit ssembeddelete"}),e.on("BeforeExecCommand",t=>{const n=t.command,o=t.ui,i=t.value;"mceMedia"===n&&(t.preventDefault(),e.execCommand("ssembed",o,i))}),e.on("GetContent",e=>{const t=(0,o.default)(`<div>${e.content}</div>`);t.find(p).each(function(){const e=(0,o.default)(this),t=e.find("img.placeholder");if(0===t.length)return e.removeAttr("data-url"),void e.removeAttr("data-shortcode");const n=e.find(".caption").text(),i=parseInt(t.attr("width"),10),a=parseInt(t.attr("height"),10),r=e.data("url"),s=(0,d.sanitiseShortCodeProperties)({url:r,thumbnail:t.prop("src"),class:e.prop("class"),width:isNaN(i)?null:i,height:isNaN(a)?null:a,caption:n}),l=d.default.serialise({name:"embed",properties:s,wrapped:!0,content:s.url});e.replaceWith(l)}),e.content=t.html()}),e.on("BeforeSetContent",e=>{let t=e.content,n=d.default.match("embed",!0,t);for(;n;){const e=n.properties,i=(0,o.default)("<div/>").attr("data-url",e.url||n.content).attr("data-shortcode","embed").addClass(e.class).addClass("ss-htmleditorfield-file embed"),a=(0,o.default)("<img />").attr("src",e.thumbnail).addClass("placeholder");if(e.width&&a.attr("width",e.width),e.height&&a.attr("height",e.height),i.append(a),e.caption){const t=(0,o.default)("<p />").addClass("caption").text(e.caption);i.append(t)}t=t.replace(n.original,(0,o.default)("<div/>").append(i).html()),n=d.default.match("embed",!0,t)}e.content=t}),{getMetadata(){return{name:"Silverstripe Embed",url:"https://docs.silverstripe.org/en/4/developer_guides/forms/field_types/htmleditorfield"}}}};tinymce.PluginManager.add("ssembed",t=>e(t))})(),o.default.entwine("ss",e=>{e(".js-injector-boot #insert-embed-react__dialog-wrapper").entwine({Element:null,Data:{},ReactRoot:null,onunmatch(){this._clearModal()},_clearModal(){const e=this.getReactRoot();e&&(e.unmount(),this.setReactRoot(null))},open(){this._renderModal(!0)},close(){this.setData({}),this._renderModal(!1)},_renderModal(e){const t=this.getOriginalAttributes();let n=this.getReactRoot();n||(n=(0,a.createRoot)(this[0])),n.render(i.default.createElement(u,{isOpen:e,onCreate:(...e)=>this._handleCreate(...e),onInsert:(...e)=>this._handleInsert(...e),onClosed:()=>this.close(),onLoadingError:(...e)=>this._handleLoadingError(...e),bodyClassName:"modal__dialog",className:"insert-embed-react__dialog-wrapper",fileAttributes:t})),this.setReactRoot(n)},_handleLoadingError(){this.setData({}),this.open()},_handleInsert(e){const t=this.getData();this.setData(Object.assign({Url:t.Url},e)),this.insertRemote(),this.close()},_handleCreate(e){this.setData(Object.assign({},this.getData(),e)),this.open()},getOriginalAttributes(){const t=this.getData(),n=this.getElement();if(!n)return t;const o=e(n.getEditor().getSelectedNode());if(!o.length)return t;const i=o.closest(p).add(o.filter(p));if(!i.length)return t;const a=i.find("img.placeholder");if(0===a.length)return t;const r=i.find(".caption").text(),d=parseInt(a.width(),10),s=parseInt(a.height(),10);return{Url:i.data("url")||t.Url,CaptionText:r,PreviewUrl:a.attr("src"),Width:isNaN(d)?null:d,Height:isNaN(s)?null:s,Placement:this.findPosition(i.prop("class"))}},findPosition(e){if("string"!=typeof e)return"";const t=e.split(" ");return["leftAlone","center","rightAlone","left","right"].find(e=>t.indexOf(e)>-1)},insertRemote(){const t=this.getElement();if(!t)return!1;const n=t.getEditor();if(!n)return!1;const i=this.getData(),a=(0,o.default)("<div/>").attr("data-url",i.Url).attr("data-shortcode","embed").addClass(i.Placement).addClass("ss-htmleditorfield-file embed"),r=(0,o.default)("<img />").attr("src",i.PreviewUrl).addClass("placeholder");if(i.Width&&r.attr("width",i.Width),i.Height&&r.attr("height",i.Height),a.append(r),i.CaptionText){const e=(0,o.default)("<p />").addClass("caption").text(i.CaptionText);a.append(e)}const d=e(n.getSelectedNode());let s=e(null);return d.length&&(s=d.filter(p),0===s.length&&(s=d.closest(p)),0===s.length&&(s=d.filter("img.placeholder"))),s.length?s.replaceWith(a):(n.repaint(),n.insertContent(e("<div />").append(a.clone()).html(),{skip_undo:1})),n.addUndo(),n.repaint(),!0}})})}();